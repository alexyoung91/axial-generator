var Alternator=function(t,a){t=d3.select(t),a=d3.select(a);var r=function(t){var a=t.attr("width"),r=t.attr("height"),e=t.attr("width")/2,n=t.attr("height")/2,s=t.append("g").attr("transform","translate("+e+","+n+")"),d=2,i=d3.svg.arc().innerRadius(e-d).outerRadius(n).startAngle(0).endAngle(2*Math.PI),p=2,h=d3.svg.arc().innerRadius(50-p).outerRadius(50).startAngle(0).endAngle(2*Math.PI);s.append("path").attr("d",i),s.append("path").attr("d",h);for(var l=new Array(9),c=0;c<l.length;c++){var g=360*c/l.length,o=Math.sin(2*c*Math.PI/l.length),u=Math.cos(2*c*Math.PI/l.length);s.append("rect").attr("x",-20).attr("y",-149).attr("width",40).attr("height",60).attr("class","coil").attr("transform","translate("+o+","+u+") rotate("+g+")"),3>c?s.append("circle").attr("cx",-20).attr("cy",-165+-7*c).attr("r",5).attr("transform","translate("+o+","+u+") rotate("+g+")").attr("class",0==c?"wire-phase1":1==c?"wire-phase2":"wire-phase3"):c>5&&s.append("circle").attr("cx",-20).attr("cy",-164+-7*(c-6)).attr("r",5).attr("transform","translate("+o+","+u+") rotate("+g+"13.5)").attr("class",c-6==0?"wire-phase1":c-6==1?"wire-phase2":"wire-phase3")}var m=d3.svg.arc().innerRadius(164).outerRadius(166).startAngle(.11).endAngle(2),v=d3.svg.arc().innerRadius(164).outerRadius(166).startAngle(2.18).endAngle(4.1);s.append("path").attr("d",m).attr("class","wire-phase1"),s.append("path").attr("d",v).attr("class","wire-phase1");var f=d3.svg.arc().innerRadius(171).outerRadius(173).startAngle(.79).endAngle(2.68),y=d3.svg.arc().innerRadius(173).outerRadius(175).startAngle(2.9).endAngle(4.8);s.append("path").attr("d",f).attr("class","wire-phase2"),s.append("path").attr("d",y).attr("class","wire-phase2");var w=d3.svg.arc().innerRadius(180).outerRadius(182).startAngle(1.3).endAngle(3.37),x=d3.svg.arc().innerRadius(180).outerRadius(182).startAngle(3.58).endAngle(5.5);s.append("path").attr("d",w).attr("class","wire-phase3"),s.append("path").attr("d",x).attr("class","wire-phase3");var M=t.append("g").attr("transform","translate("+e+","+n+")"),A=1,P=d3.svg.arc().innerRadius(e-20-A).outerRadius(n-20).startAngle(0).endAngle(2*Math.PI),R=d3.svg.arc().innerRadius(50).outerRadius(n-20).startAngle(0).endAngle(2*Math.PI);M.append("path").attr("d",P),M.append("path").attr("d",R).attr("class","rotor-body"),M.append("circle").attr("cx",0).attr("cy",0).attr("r",5).attr("class","axel");for(var c=0;4>c;c++){var o=65*Math.sin(2*c*Math.PI/4),u=65*Math.cos(2*c*Math.PI/4);M.append("circle").attr("class","bolt-hole").attr("cx",0).attr("cy",0).attr("r",3).attr("transform","translate("+o+","+u+")")}for(var c=0;12>c;c++){var g=360*c/12,o=Math.sin(2*c*Math.PI/12),u=Math.cos(2*c*Math.PI/12);M.append("rect").attr("x",-12.5).attr("y",-145).attr("width",25).attr("height",50).attr("class","magnet").attr("transform","translate("+o+","+u+") rotate("+g+")"),M.append("text").text(c%2?"S":"N").attr("x",0).attr("y",-125).attr("width",25).attr("height",50).attr("text-anchor","middle").attr("transform","translate("+o+","+u+") rotate("+g+")")}return{width:a,height:r,cx:e,cy:n,rotor:M}},e=function(t){var r=a.attr("width"),e=a.attr("height"),n=a.attr("width")/2,s=a.attr("height")/2,d=t.append("g").attr("transform","translate("+n+","+s+")"),i=20,p=e;d.append("rect").attr("x",-i/2).attr("y",-e/2).attr("width",i).attr("height",p).attr("class","stator-body");var h=10,l=e-40,c=34,g=t.append("g").attr("transform","translate("+n+","+s+")");g.append("rect").attr("x",-h/2-c).attr("y",-l/2).attr("width",h).attr("height",l).attr("class","stator-body");var o=t.append("g").attr("transform","translate("+n+","+s+")");o.append("rect").attr("x",-h/2+c).attr("y",-l/2).attr("width",h).attr("height",l).attr("class","stator-body");for(var u=t.append("g").attr("transform","translate("+n+","+s+")"),m={height:50,width:25,depth:10,pairs:new Array(12)},v=0;v<m.pairs.length;v++){var f=0,y=Math.sin(f/6+v*(Math.PI/6)),e=25+25*Math.abs(y),w=u.append("rect").attr("x",-m.depth/2-c+h).attr("y",-120*y-e/2).attr("width",m.depth).attr("height",e).attr("class","magnet"),x=u.append("rect").attr("x",-m.depth/2+c-h).attr("y",-120*y-e/2).attr("width",m.depth).attr("height",e).attr("class","magnet"),M=u.append("line").attr("x1",-c+h/2+m.depth).attr("y1",-120*y-e/2).attr("x2",c-h/2-m.depth).attr("y2",-120*y-e/2).attr("class","flux");m.pairs[v]={left:w,right:x,flux:M,z:1}}return{width:r,height:e,rotorLeft:g,rotorRight:o,magnet:m}},n=r(t),s=e(a),d=function(t){var a=t/(2*Math.PI)*60%360;n.rotor.attr("transform","translate("+n.cx+","+n.cy+") rotate("+a+")");for(var r=0;r<s.magnet.pairs.length;r++){var e=Math.sin(t/6+r*(Math.PI/6)),d=25+25*Math.abs(e);s.magnet.pairs[r].left.attr("y",-120*e-d/2).attr("height",d),s.magnet.pairs[r].right.attr("y",-120*e-d/2).attr("height",d),s.magnet.pairs[r].flux.attr("y1",-120*e).attr("y2",-120*e),e>.866&&1==s.magnet.pairs[r].z?s.magnet.pairs[r].z=0:-.9>e&&0==s.magnet.pairs[r].z&&(s.magnet.pairs[r].z=1)}};return{draw:d}},Graph=function(t){var a="x1",r="x2",e="y1",n="y2",s=d3.select(t),d=s.attr("width"),p=s.attr("height"),h=[],l=-10,c=0,g=-2,o=2,u=d3.scale.linear(),m=d3.scale.linear(),v=s.append("svg:g"),f=s.append("svg:g"),y=f.append("svg:path"),w=f.append("svg:path"),x=f.append("svg:path"),M=d3.svg.line(),A=d3.svg.line(),P=d3.svg.line(),R=0,I=.1;for(i=0;i<100;i++)h.push(i/5);u.domain([l,c]).range([0,d]),m.domain([g,o]).range([0,p]),y.attr("class","phase1"),w.attr("class","phase2"),x.attr("class","phase3"),M.x(function(t){return u(-t)}).y(function(t){return m(2*I*Math.sin(t-R))}),A.x(function(t){return u(-t+2*Math.PI/3)}).y(function(t){return m(2*I*Math.sin(t-R))}),P.x(function(t){return u(-t+4*Math.PI/3)}).y(function(t){return m(2*I*Math.sin(t-R))});var b=v.append("svg:line").attr("class","axis").attr(a,u(0)).attr(e,m(g)).attr(r,u(0)).attr(n,m(o)),E=function(t,s,d){R=t,I=s,m.domain([-d,d]).range([0,p]),b.attr(a,u(0)).attr(e,m(-d)).attr(r,u(0)).attr(n,m(d)),y.attr("d",M(h)),w.attr("d",A(h)),x.attr("d",P(h))};return{data:h,width:d,height:p,draw:E}},alternator=new Alternator("#alternator-front","#alternator-side"),graph=new Graph("#graph"),time=0,dt=.1,fps=30,paused=!1,yrange=2,period=0,frequency=0,tick=function(){alternator.draw(time),graph.draw(time,dt,yrange),paused||(time+=dt),frequency=dt*fps/(2*Math.PI),document.getElementsByName("rpm")[0].value=(10*frequency).toPrecision(3),document.getElementsByName("period")[0].value=(1/frequency).toPrecision(3),document.getElementsByName("frequency")[0].value=frequency.toPrecision(3),setTimeout(function(){window.requestAnimationFrame(tick)},1e3/fps)};tick();var speed_slider=document.getElementsByName("speed")[0];speed_slider.addEventListener("input",function(){dt=speed_slider.value/100});var yrange_slider=document.getElementsByName("yrange")[0];yrange_slider.addEventListener("input",function(){yrange=yrange_slider.value/10});var pause_button=document.getElementsByName("pause")[0];pause_button.addEventListener("click",function(){paused=!paused,pause_button.value=paused?"Play":"Pause"});